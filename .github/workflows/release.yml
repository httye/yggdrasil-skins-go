name: ğŸš€ Release Build

on:
  push:
    tags:
      - "v*"
      - "v*.*"
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release"
        required: true
        default: "v1.0.0"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    name: ğŸ”¨ Build Release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - goos: windows
            goarch: amd64
            suffix: .exe
          - goos: windows
            goarch: arm64
            suffix: .exe

          # Linux
          - goos: linux
            goarch: amd64
            suffix: ""
          - goos: linux
            goarch: arm64
            suffix: ""

          # macOS
          - goos: darwin
            goarch: amd64
            suffix: ""
          - goos: darwin
            goarch: arm64
            suffix: ""

          # FreeBSD
          - goos: freebsd
            goarch: amd64
            suffix: ""

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.5"

      - name: ğŸ”¨ Build Binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.event.inputs.tag || 'v1.0.0' }}"
          fi
          BINARY_NAME="yggdrasil-api-server-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.suffix }}"

          echo "æ„å»º ${BINARY_NAME}..."
          go build \
            -ldflags="-w -s -X main.version=${VERSION}" \
            -o "${BINARY_NAME}" \
            main.go

          # ç”Ÿæˆæ ¡éªŒå’Œ
          sha256sum "${BINARY_NAME}" > "${BINARY_NAME}.sha256"

          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          ls -la "${BINARY_NAME}"*
          echo "æ„å»ºå®Œæˆ: ${BINARY_NAME}"

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            yggdrasil-api-server-*
            *.sha256
          retention-days: 7

  # Dockeré•œåƒ
  docker:
    name: ğŸ³ Docker
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # åˆ›å»ºRelease
  release:
    name: ğŸ‰ Release
    needs: [build, docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download All Build Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: ./release
          merge-multiple: true

      - name: ğŸ“ Generate Release Checksums
        working-directory: ./release
        run: |
          echo "åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼š"
          ls -la
          echo "ç”Ÿæˆå®Œæ•´çš„æ ¡éªŒå’Œæ–‡ä»¶..."
          sha256sum yggdrasil-api-server-* > SHA256SUMS
          echo "æ ¡éªŒå’Œæ–‡ä»¶å†…å®¹ï¼š"
          cat SHA256SUMS

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Yggdrasil API Server ${{ github.ref_name }}
          files: |
            release/yggdrasil-api-server-*
            release/SHA256SUMS
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸš€ Yggdrasil API Server ${{ github.ref_name }}

            é«˜æ€§èƒ½çš„ Minecraft Yggdrasil API æœåŠ¡å™¨å®ç°ï¼Œä½¿ç”¨ Go è¯­è¨€ç¼–å†™ã€‚

            ### âœ¨ ä¸»è¦ç‰¹æ€§
            - ğŸš€ é«˜æ€§èƒ½ Gin æ¡†æ¶ï¼Œæ”¯æŒé«˜å¹¶å‘
            - ğŸ” å®Œæ•´çš„ JWT Token ç®¡ç†å’Œ RSA ç­¾å
            - ğŸ’¾ å¤šç§å­˜å‚¨åç«¯ï¼ˆæ–‡ä»¶ã€æ•°æ®åº“ã€BlessingSkinï¼‰
            - ğŸ—„ï¸ å¤šç§ç¼“å­˜æ”¯æŒï¼ˆå†…å­˜ã€Redisã€æ–‡ä»¶ã€æ•°æ®åº“ï¼‰
            - ğŸ¯ 100% å…¼å®¹ Minecraft å®˜æ–¹ Yggdrasil API
            - ğŸ“Š å†…ç½®æ€§èƒ½ç›‘æ§å’Œå¥åº·æ£€æŸ¥

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜
            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„é€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

            - **Windows**: `yggdrasil-api-server-*-windows-*.exe`
            - **Linux**: `yggdrasil-api-server-*-linux-*`
            - **macOS**: `yggdrasil-api-server-*-darwin-*`
            - **FreeBSD**: `yggdrasil-api-server-*-freebsd-*`

            ### ğŸ”’ æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
            ä½¿ç”¨ `SHA256SUMS` æ–‡ä»¶éªŒè¯ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### ğŸ³ Dockeré•œåƒ
            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ```

            ### ğŸ“ å¿«é€Ÿå¼€å§‹
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
            2. å¤åˆ¶é…ç½®æ–‡ä»¶ï¼š`cp conf/example.yml conf/config.yml`
            3. ç”Ÿæˆå¯†é’¥å¯¹ï¼š
               ```bash
               mkdir -p keys
               openssl genrsa -out keys/private.pem 2048
               openssl rsa -in keys/private.pem -pubout -out keys/public.pem
               ```
            4. å¯åŠ¨æœåŠ¡å™¨ï¼š
               ```bash
               # Linux/macOS
               chmod +x yggdrasil-api-server-*
               ./yggdrasil-api-server-* -config conf/config.yml

               # Windows
               yggdrasil-api-server-*.exe -config conf/config.yml
               ```

            ### ğŸ“š æ–‡æ¡£
            - [é…ç½®è¯´æ˜](https://github.com/${{ github.repository }}/blob/main/README.md#é…ç½®è¯´æ˜)
            - [APIæ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/docs/)
            - [éƒ¨ç½²æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/README.md#éƒ¨ç½²)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
